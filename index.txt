<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>手机 HUD 拖拽版</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <meta name="theme-color" content="#000"/>
  <style>
    /* ======== 与原文件完全相同的 CSS ======== */
    :root { --fs: 12vh; --rgb: 0,255,0; --alpha: 0; --text-alpha: 1; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; background: #000; color: rgba(var(--rgb), var(--text-alpha)); overflow: hidden; font-family: Roboto, Helvetica, Arial, sans-serif; }
    .draggable { position: absolute; touch-action: none; user-select: none; cursor: move; z-index: 1001; }
    .speed { font-size: var(--fs); font-weight: 700; letter-spacing: -0.05em; }
    .unit { font-size: calc(var(--fs) * 0.5); margin-left: 0.2em; }
    .distance { font-size: calc(var(--fs) * 0.45); }
    .icon-wrapper { width: 18vh; height: 18vh; display: block; overflow: hidden; }
    .icon-img { width: 100%; height: 100%; display: block; object-fit: contain; }
    .resize-handle { position: absolute; right: 8px; bottom: 8px; width: 28px; height: 28px; background: linear-gradient(135deg, rgba(255,255,255,0.18) 25%, rgba(0,0,0,0.05) 25%, rgba(255,255,255,0.18) 50%, rgba(0,0,0,0.05) 50%, rgba(255,255,255,0.18) 75%, rgba(0,0,0,0.05) 75%); background-size: 10px 10px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.18); cursor: nwse-resize; z-index: 1002; box-shadow: 0 6px 18px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.05); touch-action: none; transition: transform 120ms ease, box-shadow 120ms ease; }
    .resize-handle:hover { transform: scale(1.08); box-shadow: 0 8px 22px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.08); }
    .resize-handle:active { transform: scale(0.98); }
    .dimLayer { position: fixed; inset: 0; background: #000; opacity: var(--alpha); pointer-events: none; }
    .panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: #fff; padding: 10px 20px; border-radius: 8px; display: none; gap: 12px; align-items: center; font-size: 14px; }
    body.showPanel .panel { display: flex; }
    .panel input { width: 120px; }
    .inspector { position: fixed; min-width: 220px; background: rgba(20,20,20,0.95); color: #fff; padding: 8px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.6); z-index: 2000; font-size: 13px; display: none; }
    .inspector .ins-row { display: flex; align-items: center; justify-content: space-between; margin: 6px 0; }
    .inspector label { flex: 1; margin-right: 8px; }
    .tint-overlay { position: absolute; inset: 0; pointer-events: none; mix-blend-mode: multiply; opacity: 0; }
    .example-img { width: 100%; height: 100%; display: block; object-fit: cover; }
    #hudRoot.mirrored { transform: scaleX(-1); transform-origin: 50% 50%; }
    #togglePanelBtn { position: fixed; left: 12px; bottom: 18px; padding: 8px 10px; border-radius: 6px; background: rgba(255,255,255,0.06); color: inherit; border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(4px); z-index: 1000; }
  </style>
</head>
<body>
  <button id="togglePanelBtn">显示/隐藏</button>

  <div id="hudRoot">
    <div id="speed" class="draggable speed"><span id="spdVal">0</span><span class="unit">km/h</span></div>
    <div id="distance" class="draggable distance">800 m</div>

    <!-- 四个方向图标 -->
    <div id="iconStraight" class="draggable icon-wrapper">
      <img class="icon-img" src="assets/straight.svg" alt="straight">
      <div class="resize-handle"></div>
    </div>

    <div id="iconLeft" class="draggable icon-wrapper">
      <img class="icon-img" src="assets/left.svg" alt="left">
      <div class="resize-handle"></div>
    </div>

    <div id="iconRight" class="draggable icon-wrapper">
    <img class="icon-img" src="assets/right.svg" alt="right">
      <div class="resize-handle"></div>
    </div>

    <div id="iconUturn" class="draggable icon-wrapper">
      <img class="icon-img" src="assets/uturn.svg" alt="uturn">
      <div class="resize-handle"></div>
    </div>

    <!-- 示例图片 -->
    <div id="exampleImgWrapper" class="draggable img-wrapper">
      <svg id="exampleImg" class="example-img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 253 625" preserveAspectRatio="xMidYMid meet">
        <path d="M0 0 C31.35 0 62.7 0 95 0 C99.34080526 33.83846624 99.34080526 33.83846624 101.37902998 49.72751832 C103.10567127 63.18760853 104.83233312 76.6476961 106.55904664 90.10777704 C108.00821825 101.40436802 109.45736593 112.70096206 110.90649414 123.99755859 C111.04166458 125.05127071 111.17683502 126.10498282 111.31610154 127.19062561 C115.24515863 157.81941351 119.17337559 188.44830904 123.10082831 219.0773027 C125.62605121 238.77070729 128.15149395 258.46408368 130.677017 278.15744978 C131.09847916 281.44391685 131.51993448 284.73038479 131.94138885 288.01685286 C138.69691404 340.69555849 145.4586444 393.37345148 152.24189353 446.04859483 C153.5297905 456.04992642 154.81685203 466.05136522 156.10327148 476.05288696 C156.19050213 476.73105914 156.27773279 477.40923131 156.36760679 478.10795416 C157.13737463 484.09250066 157.90710091 490.07705249 158.67669058 496.0616219 C160.59500524 510.9788977 162.51627134 525.8957855 164.44281024 540.81200147 C165.61787956 549.91182537 166.78948012 559.01209127 167.95817167 568.11273646 C168.73881479 574.19043298 169.52343744 580.26759498 170.31150484 586.34433305 C170.77853287 589.9538679 171.24137502 593.56392958 171.70290828 597.17417073 C171.913025 598.81120573 172.1248518 600.44802236 172.33858037 602.08458972 C172.62733527 604.29747052 172.90984042 606.51106443 173.19081116 608.72494507 C173.34839936 609.94701849 173.50598757 611.16909191 173.66835117 612.42819786 C174.02511844 616.27052137 174 620.14114876 174 624 C90.51 624 7.02 624 -79 624 C-77.84379508 605.50072123 -77.84379508 605.50072123 -76.63113123 596.25015795 C-76.54202562 595.56546268 -76.45292 594.88076741 -76.36111421 594.1753238 C-76.26853847 593.46468771 -76.17596273 592.75405162 -76.08058167 592.0218811 C-75.88332039 590.47742316 -75.68651331 588.93290715 -75.49011368 587.3883394 C-74.95430366 583.18483263 -74.41213417 578.98216808 -73.86883414 574.77962375 C-73.28039535 570.21888076 -72.69799625 565.65736589 -72.11482239 561.09594727 C-71.09953341 553.16117924 -70.08044765 545.22690629 -69.05877876 537.29295731 C-67.55334321 525.60218118 -66.053742 513.910662 -64.55536842 502.21897893 C-62.08632642 482.95454247 -59.61259708 463.69071087 -57.13598633 444.42724609 C-54.79591646 426.22574405 -52.45797932 408.0239705 -50.12329102 389.82177734 C-49.98269621 388.72565291 -49.8421014 387.62952847 -49.69724615 386.50018814 C-49.13010305 382.07848283 -48.56297654 377.65677539 -47.99587116 373.23506524 C-34.64283808 269.12214219 -21.246211 165.01481775 -7.84291077 60.90835571 C-7.71826112 59.94017325 -7.59361147 58.97199079 -7.46518456 57.97446947 C-4.97715432 38.64959936 -2.48851039 19.32480829 0 0 Z " fill="#7C9BDA"/>
      </svg>
      <div class="resize-handle"></div>
    </div>

    <div class="dimLayer"></div>
  </div><!-- /#hudRoot -->

  <!-- 元素检查器 -->
  <div id="inspector" class="inspector" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <strong id="inspectorTitle">编辑元素</strong>
      <button id="inspectorClose" style="background:transparent;border:none;color:#fff;font-size:16px;cursor:pointer">✕</button>
    </div>
    <div class="ins-row"><label>宽度 (px)</label><input id="inspWidth" type="number" style="width:80px"></div>
    <div class="ins-row"><label>高度 (px)</label><input id="inspHeight" type="number" style="width:80px"></div>
    <div class="ins-row"><label>字号 (px)</label><input id="inspFontSize" type="number" style="width:80px"></div>
    <div class="ins-row"><label>颜色</label><input id="inspColor" type="color" style="width:80px"></div>
    <div class="ins-row"><label>色度</label><input id="inspTintAlpha" type="range" min="0" max="1" step="0.01" style="width:calc(100% - 88px)"><input id="inspTintAlphaNum" type="number" min="0" max="1" step="0.01" style="width:80px"></div>
    <div class="ins-row"><label>亮度</label><input id="inspBrightness" type="range" min="0.2" max="2" step="0.01" style="width:calc(100% - 88px)"><input id="inspBrightnessNum" type="number" min="0.2" max="2" step="0.01" style="width:80px"></div>
    <div class="ins-row"><label>透明度</label><input id="inspOpacity" type="range" min="0" max="1" step="0.01" style="width:calc(100% - 88px)"><input id="inspOpacityNum" type="number" min="0" max="1" step="0.01" style="width:80px"></div>
    <div class="ins-row"><label>图层 (z)</label><input id="inspZ" type="number" min="0" max="9999" style="width:80px"></div>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="insApply" style="flex:1">应用</button><button id="insReset" style="flex:1">重置</button></div>
  </div>

  <!-- 控制面板 -->
  <div id="panel" class="panel draggable">
    <button id="mirrorBtn">镜像</button>
  </div>

  <script>
    /* ------------------ 配置 ------------------ */
    const cfg = { fs: 12, rgb: [0,255,0], alpha: 0, mirror: false, textAlpha: 1 };
    Object.assign(cfg, JSON.parse(localStorage.getItem('hudCfg') || '{}'));
    function apply(){
      document.documentElement.style.setProperty('--fs', cfg.fs + 'vh');
      const rgbVal = Array.isArray(cfg.rgb) ? cfg.rgb.join(',') : (cfg.rgb || '0,255,0');
      document.documentElement.style.setProperty('--rgb', rgbVal);
      document.documentElement.style.setProperty('--alpha', cfg.alpha);
      document.documentElement.style.setProperty('--text-alpha', cfg.textAlpha);
      const hudRoot = document.getElementById('hudRoot');
      if (hudRoot) hudRoot.classList.toggle('mirrored', cfg.mirror);
      localStorage.setItem('hudCfg', JSON.stringify(cfg));
    }
    document.getElementById('mirrorBtn').onclick = () => { cfg.mirror = !cfg.mirror; apply(); };
    apply();

    /* ------------------ 面板显隐 ------------------ */
    document.getElementById('togglePanelBtn').onclick = () => {
      document.body.classList.toggle('showPanel');
    };

    /* ------------------ 元素检查器 ------------------ */
    const stylesKey = 'hudStyles';
    const hudStyles = JSON.parse(localStorage.getItem(stylesKey) || '{}');
    let inspectorTarget = null;

    const inspector = document.getElementById('inspector');
    const inspectorTitle = document.getElementById('inspectorTitle');
    const inspWidth = document.getElementById('inspWidth');
    const inspHeight = document.getElementById('inspHeight');
    const inspFontSize = document.getElementById('inspFontSize');
    const inspColor = document.getElementById('inspColor');
    const inspTintAlpha = document.getElementById('inspTintAlpha');
    const inspTintAlphaNum = document.getElementById('inspTintAlphaNum');
    const inspBrightness = document.getElementById('inspBrightness');
    const inspBrightnessNum = document.getElementById('inspBrightnessNum');
    const inspOpacity = document.getElementById('inspOpacity');
    const inspOpacityNum = document.getElementById('inspOpacityNum');
    const inspZ = document.getElementById('inspZ');
    const insClose = document.getElementById('inspectorClose');
    const insApply = document.getElementById('insApply');
    const insReset = document.getElementById('insReset');

    function applySavedStyles(id, el){
      const s = hudStyles[id];
      if (!s) return;
      if (s.width) el.style.width = s.width;
      if (s.height) el.style.height = s.height;
      if (s.fontSize) el.style.fontSize = s.fontSize;
      if (s.color) {
        const svgChild = el.querySelector && el.querySelector('svg');
        const img = el.querySelector && el.querySelector('img');
        if (svgChild) {
          el.style.color = s.color;
        } else if (img && (s.recolored || isPngSrc(img.src) || isPngSrc(s.originalSrc || img.dataset.__origSrc))) {
          if (s.recolored) img.src = s.recolored;
          else if (s.color) {
            const orig = s.originalSrc || img.dataset.__origSrc || img.src;
            img.dataset.__origSrc = orig;
            recolorPngImage(img, s.color).then(res => {
              if (res.success) {
                s.recolored = res.dataUrl;
                localStorage.setItem(stylesKey, JSON.stringify(hudStyles));
              } else ensureTint(el, s.color, s.tintAlpha || 0);
            });
          }
        } else {
          if (el.classList.contains('speed') || el.classList.contains('distance')) el.style.color = s.color;
          else ensureTint(el, s.color, s.tintAlpha || 0);
        }
      }
      if (s.brightness) el.style.filter = `brightness(${s.brightness})`;
      if (typeof s.opacity !== 'undefined') el.style.opacity = s.opacity;
      if (s.zIndex) el.style.zIndex = s.zIndex;
    }

    function ensureTint(el, color, alpha) {
      if (!el.classList.contains('icon-wrapper')) return;
      el.style.position = el.style.position || 'absolute';
      let ov = el.querySelector('.tint-overlay');
      if (!ov) {
        ov = document.createElement('div');
        ov.className = 'tint-overlay';
        el.appendChild(ov);
      }
      ov.style.background = color || '#000000';
      ov.style.opacity = (typeof alpha === 'number') ? alpha : 0;
    }

    function isPngSrc(src) {
      if (!src) return false;
      return src.indexOf('.png') !== -1 || src.indexOf('image/png') !== -1;
    }

    async function recolorPngImage(imgEl, hexColor) {
      try {
        const origSrc = imgEl.getAttribute('src');
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.src = origSrc;
        await new Promise((res, rej) => { img.onload = res; img.onerror = () => rej(new Error('img load error')); });
        const w = img.naturalWidth || img.width;
        const h = img.naturalHeight || img.height;
        const c = document.createElement('canvas');
        c.width = w;
        c.height = h;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        const data = ctx.getImageData(0, 0, w, h);
        const d = data.data;
        const tr = parseInt(hexColor.slice(1, 3), 16);
        const tg = parseInt(hexColor.slice(3, 5), 16);
        const tb = parseInt(hexColor.slice(5, 7), 16);
        for (let i = 0; i < d.length; i += 4) {
          const r = d[i], g = d[i + 1], b = d[i + 2], a = d[i + 3];
          if (a === 0) continue;
          const lum = 0.299 * r + 0.587 * g + 0.114 * b;
          d[i] = Math.round(tr * (lum / 255));
          d[i + 1] = Math.round(tg * (lum / 255));
          d[i + 2] = Math.round(tb * (lum / 255));
        }
        ctx.putImageData(data, 0, 0);
        const url = c.toDataURL('image/png');
        if (!imgEl.dataset.__origSrc) imgEl.dataset.__origSrc = origSrc;
        imgEl.src = url;
        return { success: true, dataUrl: url };
      } catch (err) {
        console.warn('recolorPngImage failed, fallback to overlay', err);
        return { success: false };
      }
    }

    /* 初始化已保存样式 */
    document.querySelectorAll('.draggable').forEach(el => {
      if (hudStyles[el.id]) applySavedStyles(el.id, el);
    });

    /* 点击显示检查器 */
    document.querySelectorAll('.draggable').forEach(el => {
      el.addEventListener('click', e => {
        e.stopPropagation();
        showInspectorFor(el);
      });
    });

    function showInspectorFor(el) {
      inspectorTarget = el;
      inspectorTitle.textContent = el.id || el.className || '元素';
      const rect = el.getBoundingClientRect();
      inspector.style.left = Math.min(window.innerWidth - 240, rect.right + 8) + 'px';
      inspector.style.top = Math.max(8, rect.top) + 'px';
      inspector.style.display = 'block';
      inspector.setAttribute('aria-hidden', 'false');

      const cs = getComputedStyle(el);
      inspWidth.value = parseInt(cs.width) || '';
      inspHeight.value = parseInt(cs.height) || '';
      inspFontSize.value = parseInt(cs.fontSize) || '';
      const col = cs.color;
      inspColor.value = rgbToHex(col) || '#00ff00';

      const ov = el.querySelector && el.querySelector('.tint-overlay');
      inspTintAlpha.value = ov ? parseFloat(ov.style.opacity || 0) : 0;
      if (inspTintAlphaNum) inspTintAlphaNum.value = inspTintAlpha.value;

      inspBrightness.value = (el.style.filter && parseBrightness(el.style.filter)) || 1;
      if (inspBrightnessNum) inspBrightnessNum.value = inspBrightness.value;

      inspOpacity.value = parseFloat(cs.opacity) || 1;
      if (inspOpacityNum) inspOpacityNum.value = inspOpacity.value;

      inspZ.value = el.style.zIndex || parseInt(cs.zIndex) || 1001;
    }

    function hideInspector() {
      inspector.style.display = 'none';
      inspector.setAttribute('aria-hidden', 'true');
      inspectorTarget = null;
    }
    insClose.addEventListener('click', hideInspector);

    function parseBrightness(filter) {
      const m = /brightness\(([^)]+)\)/.exec(filter || '');
      return m ? parseFloat(m[1]) : 1;
    }

    function rgbToHex(rgb) {
      if (!rgb) return null;
      const m = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
      if (!m) return null;
      return '#' + [1, 2, 3].map(i => parseInt(m[i]).toString(16).padStart(2, '0')).join('');
    }

    /* 应用按钮 */
    insApply.addEventListener('click', () => {
      if (!inspectorTarget) return;
      const el = inspectorTarget;
      const id = el.id || ('el_' + Math.random().toString(36).slice(2, 8));
      const s = hudStyles[id] = hudStyles[id] || {};

      if (inspWidth.value) {
        el.style.width = inspWidth.value + 'px';
        s.width = el.style.width;
      } else {
        el.style.width = '';
        delete s.width;
      }

      if (inspHeight.value) {
        el.style.height = inspHeight.value + 'px';
        s.height = el.style.height;
      } else {
        el.style.height = '';
        delete s.height;
      }

      if (inspFontSize.value) {
        el.style.fontSize = inspFontSize.value + 'px';
        s.fontSize = el.style.fontSize;
      } else {
        el.style.fontSize = '';
        delete s.fontSize;
      }

      if (inspColor.value) {
        const hex = inspColor.value;
        const svgChild = el.querySelector && el.querySelector('svg');
        const img = el.querySelector && el.querySelector('img');
        if (svgChild) {
          el.style.color = hex;
          s.color = hex;
        } else if (img && isPngSrc(img.src)) {
          recolorPngImage(img, hex).then(res => {
            if (res.success) {
              s.recolored = res.dataUrl;
              s.originalSrc = img.dataset.__origSrc || img.src;
              s.color = hex;
              s.tintAlpha = parseFloat(inspTintAlpha.value);
              localStorage.setItem(stylesKey, JSON.stringify(hudStyles));
            } else {
              ensureTint(el, hex, parseFloat(inspTintAlpha.value));
              s.color = hex;
              s.tintAlpha = parseFloat(inspTintAlpha.value);
              localStorage.setItem(stylesKey, JSON.stringify(hudStyles));
            }
          });
        } else if (el.classList.contains('speed') || el.classList.contains('distance')) {
          el.style.color = hex;
          s.color = hex;
        } else {
          ensureTint(el, hex, parseFloat(inspTintAlpha.value));
          s.color = hex;
          s.tintAlpha = parseFloat(inspTintAlpha.value);
        }
      }

      const bVal = parseFloat(inspBrightness.value);
      if (!isNaN(bVal)) {
        el.style.filter = `brightness(${bVal})`;
        s.brightness = bVal;
      }

      const oVal = parseFloat(inspOpacity.value);
      if (!isNaN(oVal)) {
        el.style.opacity = oVal;
        s.opacity = oVal;
      }

      if (inspZ.value) {
        el.style.zIndex = inspZ.value;
        s.zIndex = inspZ.value;
      }

      localStorage.setItem(stylesKey, JSON.stringify(hudStyles));
    });

    /* 重置按钮 */
    insReset.addEventListener('click', () => {
      if (!inspectorTarget) return;
      const el = inspectorTarget;
      const id = el.id;
      if (hudStyles[id]) {
        delete hudStyles[id];
        localStorage.setItem(stylesKey, JSON.stringify(hudStyles));
      }
      el.style.width = '';
      el.style.height = '';
      el.style.fontSize = '';
      el.style.color = '';
      el.style.filter = '';
      el.style.opacity = '';
      el.style.zIndex = '';
      const ov = el.querySelector && el.querySelector('.tint-overlay');
      if (ov) ov.style.opacity = 0;
      const img = el.querySelector && el.querySelector('img');
      if (img && img.dataset && img.dataset.__origSrc) {
        img.src = img.dataset.__origSrc;
        delete img.dataset.__origSrc;
      }
      hideInspector();
    });

    /* 双向同步 range <-> number */
    if (inspBrightness && inspBrightnessNum) {
      inspBrightness.addEventListener('input', () => {
        inspBrightnessNum.value = inspBrightness.value;
      });
      inspBrightnessNum.addEventListener('input', () => {
        inspBrightness.value = inspBrightnessNum.value;
      });
    }
    if (inspOpacity && inspOpacityNum) {
      inspOpacity.addEventListener('input', () => {
        inspOpacityNum.value = inspOpacity.value;
      });
      inspOpacityNum.addEventListener('input', () => {
        inspOpacity.value = inspOpacityNum.value;
      });
    }
    if (inspTintAlpha && inspTintAlphaNum) {
      inspTintAlpha.addEventListener('input', () => {
        inspTintAlphaNum.value = inspTintAlpha.value;
      });
      inspTintAlphaNum.addEventListener('input', () => {
        inspTintAlpha.value = inspTintAlphaNum.value;
      });
    }

    /* 实时预览 */
    function previewInspectorChange() {
      if (!inspectorTarget) return;
      const el = inspectorTarget;
      if (inspColor && inspColor.value) {
        const svgChild = el.querySelector && el.querySelector('svg');
        if (svgChild) {
          el.style.color = inspColor.value;
        } else {
          ensureTint(el, inspColor.value, parseFloat(inspTintAlpha.value || 0));
        }
      }
      if (inspTintAlpha) {
        ensureTint(el, inspColor ? inspColor.value : '#000000', parseFloat(inspTintAlpha.value || 0));
      }
      if (inspBrightness) {
        el.style.filter = `brightness(${parseFloat(inspBrightness.value || 1)})`;
        if (inspBrightnessNum) inspBrightnessNum.value = inspBrightness.value;
      }
      if (inspOpacity) {
        el.style.opacity = parseFloat(inspOpacity.value || 1);
        if (inspOpacityNum) inspOpacityNum.value = inspOpacity.value;
      }
    }

    if (inspColor) inspColor.addEventListener('input', previewInspectorChange);
    if (inspTintAlpha) inspTintAlpha.addEventListener('input', previewInspectorChange);
    if (inspBrightness) inspBrightness.addEventListener('input', previewInspectorChange);
    if (inspOpacity) inspOpacity.addEventListener('input', previewInspectorChange);

    /* 点击空白关闭检查器 */
    document.addEventListener('click', (e) => {
      if (inspector && !inspector.contains(e.target)) hideInspector();
    });

    /* ------------------ 拖拽 / 缩放 ------------------ */
    const posKey = 'hudPos';
    const pos = JSON.parse(localStorage.getItem(posKey) || '{}');

    function initPos(el) {
      const id = el.id;
      if (pos[id]) {
        el.style.left = pos[id].x;
        el.style.top = pos[id].y;
        if (pos[id].w) el.style.width = pos[id].w;
        if (pos[id].h) el.style.height = pos[id].h;
      } else {
        switch (id) {
          case 'iconStraight':
            el.style.left = '12px';
            el.style.top = '12px';
            break;
          case 'iconLeft':
            el.style.left = '12px';
            el.style.top = '120px';
            break;
          case 'iconRight':
            el.style.left = '12px';
            el.style.top = '240px';
            break;
          case 'iconUturn':
            el.style.left = '12px';
            el.style.top = '360px';
            break;
          case 'distance':
            el.style.left = '12px';
            el.style.top = '8vh';
            break;
          case 'speed':
            el.style.left = '50%';
            el.style.top = '10vh';
            el.style.transform = 'translateX(-50%)';
            break;
          default:
            el.style.left = '50%';
            el.style.top = '50%';
            el.style.transform = 'translate(-50%,-50%)';
        }
      }
    }
    document.querySelectorAll('.draggable').forEach(initPos);

    function dragStart(e) {
      const el = e.currentTarget;
      if (e.target && e.target.closest && e.target.closest('input,button,select,textarea,label')) return;
      if (e.target && e.target.classList && e.target.classList.contains('resize-handle')) return;

      const touch = e.type.includes('touch');
      const pt = touch ? e.touches[0] : e;
      const rect = el.getBoundingClientRect();
      const offsetX = pt.clientX - rect.left;
      const offsetY = pt.clientY - rect.top;
      el.style.transform = 'none';

      function move(ev) {
        const p = touch ? ev.touches[0] : ev;
        const x = p.clientX - offsetX;
        const y = p.clientY - offsetY;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
      }

      function end() {
        pos[el.id] = { x: el.style.left, y: el.style.top };
        if (el.style.width) pos[el.id].w = el.style.width;
        if (el.style.height) pos[el.id].h = el.style.height;
        localStorage.setItem(posKey, JSON.stringify(pos));
        document.removeEventListener(touch ? 'touchmove' : 'mousemove', move);
        document.removeEventListener(touch ? 'touchend' : 'mouseup', end);
      }

      document.addEventListener(touch ? 'touchmove' : 'mousemove', move, { passive: true });
      document.addEventListener(touch ? 'touchend' : 'mouseup', end);
    }

    document.querySelectorAll('.draggable').forEach(el => {
      el.addEventListener('mousedown', dragStart);
      el.addEventListener('touchstart', dragStart, { passive: true });
    });

    function resizeStart(e) {
      e.stopPropagation();
      const handle = e.currentTarget;
      const wrapper = handle.parentElement;
      const touch = e.type.includes('touch');
      const startX = touch ? e.touches[0].clientX : e.clientX;
      const startY = touch ? e.touches[0].clientY : e.clientY;
      const rect = wrapper.getBoundingClientRect();
      const startW = rect.width;
      const startH = rect.height;

      function move(ev) {
        const p = touch ? ev.touches[0] : ev;
        const dx = p.clientX - startX;
        const dy = p.clientY - startY;
        const newW = Math.max(24, Math.round(startW + dx));
        const newH = Math.max(24, Math.round(startH + dy));
        wrapper.style.width = newW + 'px';
        wrapper.style.height = newH + 'px';
      }

      function end() {
        pos[wrapper.id] = pos[wrapper.id] || {};
        pos[wrapper.id].w = wrapper.style.width;
        pos[wrapper.id].h = wrapper.style.height;
        localStorage.setItem(posKey, JSON.stringify(pos));
        document.removeEventListener(touch ? 'touchmove' : 'mousemove', move);
        document.removeEventListener(touch ? 'touchend' : 'mouseup', end);
      }

      document.addEventListener(touch ? 'touchmove' : 'mousemove', move, { passive: true });
      document.addEventListener(touch ? 'touchend' : 'mouseup', end);
    }

    document.querySelectorAll('.resize-handle').forEach(h => {
      h.addEventListener('mousedown', resizeStart);
      h.addEventListener('touchstart', resizeStart, { passive: true });
    });

    /* ------------------ 图标切换 ------------------ */
    const icons = ['iconStraight', 'iconLeft', 'iconRight', 'iconUturn'];
    let activeIcon = icons[Math.floor(Math.random() * icons.length)];

    function showActive(id) {
      icons.forEach(i => {
        const el = document.getElementById(i);
        if (!el) return;
        el.style.display = (i === id) ? 'block' : 'none';
      });
    }

    function switchIcon(nextId) {
      if (nextId === activeIcon) return;
      const prevEl = document.getElementById(activeIcon);
      const nextEl = document.getElementById(nextId);
      if (prevEl && nextEl) {
        nextEl.style.left = prevEl.style.left;
        nextEl.style.top = prevEl.style.top;
        pos[nextId] = pos[nextId] || {};
        pos[nextId].x = nextEl.style.left;
        pos[nextId].y = nextEl.style.top;
        if (pos[activeIcon] && (pos[activeIcon].w || pos[activeIcon].h)) {
          if (pos[activeIcon].w) nextEl.style.width = pos[activeIcon].w, pos[nextId].w = pos[activeIcon].w;
          if (pos[activeIcon].h) nextEl.style.height = pos[activeIcon].h, pos[nextId].h = pos[activeIcon].h;
        }
        localStorage.setItem(posKey, JSON.stringify(pos));
      }
      activeIcon = nextId;
      showActive(activeIcon);
    }

    showActive(activeIcon);
    setInterval(() => {
      const candidates = icons.filter(i => i !== activeIcon);
      const next = candidates[Math.floor(Math.random() * candidates.length)];
      switchIcon(next);
    }, 5000);

    /* ------------------ 假数据 ------------------ */
    setInterval(() => {
      const speed = Math.floor(Math.random() * (120 - 80 + 1)) + 80;
      document.getElementById('spdVal').textContent = speed;
    }, 300);

    let dist = 800;
    setInterval(() => {
      dist -= 8;
      if (dist <= 0) dist = 800;
      document.getElementById('distance').textContent = dist + ' m';
    }, 500);
    
    /* ------------------ 在运行时把外部 SVG 内联以保持颜色可控 ------------------ */
    (async function inlineExternalSvgs(){
      try {
        const imgs = Array.from(document.querySelectorAll('img.icon-img'));
        for (const img of imgs) {
          const src = img.getAttribute('src') || '';
          if (!src.toLowerCase().endsWith('.svg')) continue;
          try {
            const resp = await fetch(src);
            if (!resp.ok) throw new Error('fetch failed ' + resp.status);
            const text = await resp.text();
            const doc = new DOMParser().parseFromString(text, 'image/svg+xml');
            const svg = doc.querySelector('svg');
            if (!svg) continue;
            svg.classList.add('icon-img');
            // 如果没有 viewBox，则根据 width/height 设置一个，确保可缩放
            const hasViewBox = svg.getAttribute('viewBox');
            const wAttr = svg.getAttribute('width');
            const hAttr = svg.getAttribute('height');
            if (!hasViewBox && wAttr && hAttr) {
              const w = parseFloat(wAttr);
              const h = parseFloat(hAttr);
              if (!isNaN(w) && !isNaN(h) && w > 0 && h > 0) svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
            }
            // 移除静态 width/height，以便 CSS 控制尺寸；并确保按比例居中缩放
            svg.removeAttribute('width'); svg.removeAttribute('height');
            svg.setAttribute('preserveAspectRatio', svg.getAttribute('preserveAspectRatio') || 'xMidYMid meet');
            svg.style.width = '100%'; svg.style.height = '100%';
            svg.querySelectorAll('[fill]').forEach(el=>{ if (el.getAttribute('fill') && el.getAttribute('fill').toLowerCase() !== 'none') el.setAttribute('fill','currentColor'); });
            svg.querySelectorAll('[stroke]').forEach(el=>{ if (el.getAttribute('stroke') && el.getAttribute('stroke').toLowerCase() !== 'none') el.setAttribute('stroke','currentColor'); });
            img.parentNode.replaceChild(svg, img);
            const wrapper = svg.closest && svg.closest('.draggable');
            if (wrapper) applySavedStyles(wrapper.id, wrapper);
          } catch (err) {
            console.warn('inline svg failed for', src, err);
          }
        }

        // 处理页面中已内联的 SVG（例如 exampleImg），确保它们也使用 currentColor 并有合适的 viewBox
        document.querySelectorAll('.draggable svg, #exampleImg').forEach(svgEl => {
          const hasV = svgEl.getAttribute('viewBox');
          const wA = svgEl.getAttribute('width');
          const hA = svgEl.getAttribute('height');
          if (!hasV && wA && hA) {
            const wn = parseFloat(wA); const hn = parseFloat(hA);
            if (!isNaN(wn) && !isNaN(hn) && wn > 0 && hn > 0) svgEl.setAttribute('viewBox', `0 0 ${wn} ${hn}`);
          }
          svgEl.removeAttribute('width'); svgEl.removeAttribute('height');
          svgEl.setAttribute('preserveAspectRatio', svgEl.getAttribute('preserveAspectRatio') || 'xMidYMid meet');
          svgEl.style.width = '100%'; svgEl.style.height = '100%';
          svgEl.querySelectorAll('[fill]').forEach(el=>{ if (el.getAttribute('fill') && el.getAttribute('fill').toLowerCase() !== 'none') el.setAttribute('fill','currentColor'); });
          svgEl.querySelectorAll('[stroke]').forEach(el=>{ if (el.getAttribute('stroke') && el.getAttribute('stroke').toLowerCase() !== 'none') el.setAttribute('stroke','currentColor'); });
        });
      } catch (e) {
        console.warn('inlineExternalSvgs error', e);
      }
    })();
  </script>
</body>
</html>